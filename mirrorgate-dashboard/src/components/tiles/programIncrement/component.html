<!doctype html>
<!--
  ~ Copyright 2017 Banco Bilbao Vizcaya Argentaria, S.A.
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<!-- incidences:js component.min.js -->
<script src="model.js"></script>
<script src="controller.js"></script>
<!-- endbuild -->

<template>
  <style>
    @import "css/styles.css";
  </style>

  <div class="pi component__content">
    <div class="component__header">
      <h2 class="title">Program Increment</h2>
      <h3 class="title-desc" rv-hide="programIncrement.features">No data for PI</h3>
    </div>
    <div class="component__body">
      <svg>
        <g class="main">
          <g class="slices"></g>
          <g class="data">
            <g rv-show="selected">
              <switch>
                <foreignObject x="-250" y="-250" width="500" height="500">
                  <div xmlns="http://www.w3.org/1999/xhtml">
                    <p>
                      <span class="feature-name">{selected.name}</span>
                      <span class="feature-status" rv-pclass-status="selected.status">Status: {selected.status}</span>
                    </p>
                  </div>
                </foreignObject>
                <text x="20" y="20"></text>
              </switch>
            </g>
            <g rv-hide="selected">
              <g rv-show="programIncrement.features">
                <text class="rate-completed" y="0">{programIncrement.stats.completedFeatureCount} of {programIncrement.stats.featureCount}</text>
                <text class="text-completed" y="100">features completed</text>
                <!--<text class="days-left" y="300">
                  {pi.daysLeft} days left
                </text>-->
              </g>
            </g>
          </g>
          <g class="time"></g>
        </g>
      </svg>
    </div>
  </div>
</template>

<script>
  (function (window, document, undefined) {

    // Refers to the "importee", which is components/builds-dashboard.html
    var thisDoc = (document._currentScript || document.currentScript).ownerDocument;
    var tmpl = thisDoc.querySelector('template');

    var order = {
      'DONE': 3,
      'IN_PROGRESS': 2,
      'IMPEDED': 1,
      'WAITING': 0,
      'BACKLOG': 0
    };

    //D3JS initializations
    function completedRate(item) {
      var children = item.children;
      if(!children || !children.length) {
        return order[item.status];
      }
      var count = 0;
      children.forEach(function(element) {
        count+= completedRate(element);
      });
      return count / children.length;
    }

    var partition = d3.layout.partition()
        .sort(function (a, b) {
          return completedRate(a) > completedRate(b) ? -1 : 1;
        })
        .size([3/2 * Math.PI, 1])
        .value(function(d) { return d.size; });

    var y = d3.scale.pow().exponent(0.5).range([400, 530]);

    var arc = d3.svg.arc()
        .startAngle(function(d) { return d.x - 3 * Math.PI/4; })
        .endAngle(function(d) { return d.x + d.dx  - 3 * Math.PI/4; })
        .padAngle(Math.PI/180)
        .cornerRadius(20)
        .innerRadius(function (d) { return d.y === 0 ? 0 : Math.max(0, y(d.y-0.25)) + ((d.y-0.25) && (5)); })
        .outerRadius(function (d) { return d.y === 0 ? 0 : Math.max(0, y((d.y-0.25) + d.dy)) - 5; });

    // Creates an object based in the HTML Element prototype
    var MyElementProto = Object.create(Tile);

    function storyClassBuilder(prefix) {
      return function (d) {
        if(d.status) {
          return prefix + Utils.toClassName(d.status);
        } else {
          return prefix + 'hidden';
        }
      }
    }

    MyElementProto.processAlerts = function (data) {
      Utils.raiseEvent(this, {
        status: data ? 'unknown' : 'server-error'
      });
    }

    MyElementProto.getControllerClass = function () {
      return ProgramIncrementController;
    };

    MyElementProto.getTemplate = function () {
      return tmpl;
    };

    // Fires when an instance of the element is created
    MyElementProto.render = function (data) {
      var model = this.getModel();

      function mouseEnterHandler (d) {
        model.selected = d;
        svg.classed('dimmed', true);
      }

      this.processAlerts(data);

      if (data) {
        model.programIncrement = data;

        //Distribute size so that all features take the same width
        model.programIncrement.features.forEach(function(feature) {
          feature.size = 1;
          if(feature.children.length) {
            var size = 1/feature.children.length;
            feature.children.forEach(function(story) {
              story.size = size;
            });
          }
        });

        var style = window.getComputedStyle(this.shadowRoot.querySelector('.component__body'));

        var marginTop = 0;

        var width = parseFloat(style.width.substring(0, style.width.length - 2)),
          height = parseFloat(style.height.substring(0, style.height.length - 2)),
          radius = Math.min(width, height) / 2;

        width = 2 * radius;

        var container = d3.select(this.shadowRoot).select("svg")
          .attr('preserveAspectRatio', 'xMidYMid meet')
          .attr('viewBox', '0 0 ' + (radius * 2) + ' ' + (radius * 2))

        var svg = container
          .select("g.main").attr("transform",
          "translate(" + radius + "," + (radius + marginTop) + ") " +
          "scale(" + (radius / 530) + ")"
          ).on('mouseout', function (d) {
            svg.classed('dimmed', false);
            model.selected = undefined;
          });

        var featureData = svg.select('.slices').selectAll('path')
          .data(partition.nodes({
            children: model.programIncrement.features
          }));

        featureData
          .attr('d', arc)
          .attr('class', storyClassBuilder('status-'));

        featureData.enter()
          .append('path')
          .on('mouseenter', mouseEnterHandler)
          .attr('d', arc)
          .attr('class', storyClassBuilder('status-'));

      }
    };

    window.MyElement = document.registerElement('program-increment-tile', {
      prototype: MyElementProto
    });

  })(window, document);

</script>
