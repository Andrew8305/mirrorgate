<!doctype html>
<!--
  ~ Copyright 2017 Banco Bilbao Vizcaya Argentaria, S.A.
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<!-- incidences:js component.min.js -->
<script src="model.js"></script>
<script src="controller.js"></script>
<!-- endbuild -->

<template>
  <style>
    @import "css/styles.css";
  </style>

  <div class="pi component__content">
    <div class="component__header">
      <h2 class="title">Program Increment</h2>
    </div>
    <div class="component__body">
      <svg>
        <g class="main">
          <g class="original"></g>
          <g class="outher"></g>
          <g class="data">
            <g rv-show="selected">
              <switch>
                <foreignObject x="-250" y="-250" width="500" height="500">
                  <div xmlns="http://www.w3.org/1999/xhtml">
                    <p>
                      <span class="feature-name">{selected.name}</span>
                      <span class="feature-status" rv-pclass-status="selected.status">Status: {selected.status}</span>
                    </p>
                  </div>
                </foreignObject>
                <text x="20" y="20"></text>
              </switch>
            </g>
            <g rv-hide="selected">
              <g rv-show="programIncrement.features">
                <text class="rate-completed" y="0">{programIncrement.stats.completedFeatureCount} of {programIncrement.stats.featureCount}</text>
                <text class="text-completed" y="100">features completed</text>
                <!--<text class="days-left" y="300">
                  {pi.daysLeft} days left
                </text>-->
              </g>
            </g>
          </g>
          <g class="time"></g>
        </g>
      </svg>
    </div>
  </div>
</template>

<script>
  (function (window, document, undefined) {

    // Refers to the "importee", which is components/builds-dashboard.html
    var thisDoc = (document._currentScript || document.currentScript).ownerDocument;
    var tmpl = thisDoc.querySelector('template');

    // Creates an object based in the HTML Element prototype
    var MyElementProto = Object.create(Tile);

    var outherArc = d3.svg.arc()
      .innerRadius(483)
      .padAngle(Math.PI / 90)
      .outerRadius(500)
      .cornerRadius(17);

    var pie = d3.layout.pie()
      .startAngle(-Math.PI * 3 / 4)
      .endAngle(Math.PI * 3 / 4)
      .padAngle(Math.PI / 45)
      .value(function (d) { return d.points || 0.5; })
      .sort(null);

    function storyClassBuilder(prefix) {
      return function (d) {
        return prefix + Utils.toClassName(d.data.status);
      }
    }

    MyElementProto.processAlerts = function (data) {
      Utils.raiseEvent(this, {
        status: data ? 'unknown' : 'server-error'
      });
    }

    MyElementProto.getControllerClass = function () {
      return ProgramIncrementController;
    };

    MyElementProto.getTemplate = function () {
      return tmpl;
    };

    // Fires when an instance of the element is created
    MyElementProto.render = function (data) {

      this.processAlerts(data);

      var model = this.getModel();

      if (data) {
        model.programIncrement = data;

        var style = window.getComputedStyle(this.shadowRoot.querySelector('.component__body'));

        var marginTop = 0;

        var width = parseFloat(style.width.substring(0, style.width.length - 2)),
          height = parseFloat(style.height.substring(0, style.height.length - 2)),
          radius = Math.min(width, height) / 2;

        width = 2 * radius;

        var container = d3.select(this.shadowRoot).select("svg");

        container
          .attr('preserveAspectRatio', 'xMidYMid meet')
          .attr('viewBox', '0 0 ' + (radius * 2) + ' ' + (radius * 2))
        var svg = container
          .select("g.main").attr("transform",
          "translate(" + radius + "," + (radius + marginTop) + ") " +
          "scale(" + (radius / 530) + ")"
          );

        var arc = d3.svg.arc()
          .innerRadius(400)
          .outerRadius(450)
          .cornerRadius(function (d, i) {
            return (i === 0 || i === model.programIncrement.features.length - 1) && 100;
          });

        svg.on('mouseout', function (d) {
          svg.classed('dimmed', false)
          model.selected = undefined;
        });

        var innerUpdated = svg.select('.original')
          .selectAll("g")
          .data(pie(model.programIncrement.features));

        innerUpdated.select("path.item")
          .attr("class", storyClassBuilder('item status-'))
          .on('mouseenter', mouseEnterHandler)
          .attr("d", arc);

        innerUpdated.exit().remove();

        function mouseEnterHandler (d) {
          model.selected = d.data;
          svg.classed('dimmed', true);
        }

        var innerEntered = innerUpdated.enter().append('g');
        innerEntered.append("path")
          .on('mouseenter', mouseEnterHandler)
          .attr("class", storyClassBuilder('item status-'))
          .attr("d", arc);

        //Rounded corner patch for hemicircle
        innerUpdated.select("path.patch")
          .on('mouseenter', mouseEnterHandler)
          .attr("class", storyClassBuilder('patch status-'))
          .attr("d", function (d, i) {
            return arc({
              startAngle: i === 0 ? d.startAngle + Math.PI / 45 : d.startAngle,
              endAngle: i === model.programIncrement.features.length - 1 ? d.endAngle - Math.PI / 45 : d.endAngle,
              padAngle: Math.PI / 180
            });
          });
        innerEntered.append("path").attr("class", "patch")
          .on('mouseenter', mouseEnterHandler)
          .attr("class", storyClassBuilder('patch status-'))
          .attr("d", function (d, i) {
            return arc({
              startAngle: i === 0 ? d.startAngle + Math.PI / 45 : d.startAngle,
              endAngle: i === model.programIncrement.features.length - 1 ? d.endAngle - Math.PI / 45 : d.endAngle,
              padAngle: Math.PI / 180
            });
          });
        //-//Rounded patch

      }
    };

    window.MyElement = document.registerElement('program-increment-tile', {
      prototype: MyElementProto
    });

  })(window, document);

</script>
